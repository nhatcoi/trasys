const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function runInsertSQL() {
    try {
        console.log('üè• Ch·∫°y l·ªánh INSERT cho Tr∆∞·ªùng Y D∆∞·ª£c...\n');

        // 1. Disable trigger
        console.log('üîÑ Disable trigger...');
        await prisma.$executeRaw`
            ALTER TABLE hr.org_assignment DISABLE TRIGGER trg_hr_org_assignment_log;
        `;
        console.log('‚úÖ ƒê√£ disable trigger');

        // 2. Insert assignments
        console.log('\nüîÑ Insert assignments...');
        await prisma.$executeRaw`
            INSERT INTO hr.org_assignment (employee_id, org_unit_id, position_id, assignment_type, is_primary, allocation, start_date) VALUES
            -- Hi·ªáu tr∆∞·ªüng Tr∆∞·ªùng Y D∆∞·ª£c
            (2, 28, 8, 'admin', true, 1.00, '2020-01-01'),
            
            -- Ph√≥ Hi·ªáu tr∆∞·ªüng Tr∆∞·ªùng Y D∆∞·ª£c  
            (3, 28, 9, 'admin', true, 1.00, '2020-01-01'),
            
            -- Tr∆∞·ªüng khoa D∆∞·ª£c
            (4, 29, 1, 'admin', true, 1.00, '2020-01-01'),
            
            -- Tr∆∞·ªüng khoa ƒêi·ªÅu d∆∞·ª°ng
            (5, 30, 1, 'admin', true, 1.00, '2020-01-01'),
            
            -- Gi·∫£ng vi√™n Khoa D∆∞·ª£c
            (6, 29, 5, 'academic', true, 1.00, '2020-01-01'),
            (7, 29, 5, 'academic', true, 1.00, '2020-01-01'),
            
            -- Gi·∫£ng vi√™n Khoa ƒêi·ªÅu d∆∞·ª°ng
            (8, 30, 5, 'academic', true, 1.00, '2020-01-01'),
            (9, 30, 5, 'academic', true, 1.00, '2020-01-01');
        `;
        console.log('‚úÖ Insert th√†nh c√¥ng!');

        // 3. Enable l·∫°i trigger
        console.log('\nüîÑ Enable l·∫°i trigger...');
        await prisma.$executeRaw`
            ALTER TABLE hr.org_assignment ENABLE TRIGGER trg_hr_org_assignment_log;
        `;
        console.log('‚úÖ ƒê√£ enable l·∫°i trigger');

        // 4. Ki·ªÉm tra k·∫øt qu·∫£
        console.log('\nüìã Ki·ªÉm tra k·∫øt qu·∫£:');
        const results = await prisma.$queryRaw`
            SELECT 
                oa.id,
                e.employee_no,
                u.full_name,
                ou.name as org_unit_name,
                jp.title as position_title,
                oa.assignment_type
            FROM hr.org_assignment oa
            JOIN hr.employees e ON oa.employee_id = e.id
            JOIN public.users u ON e.user_id = u.id
            JOIN public.org_units ou ON oa.org_unit_id = ou.id
            LEFT JOIN hr.job_positions jp ON oa.position_id = jp.id
            WHERE ou.id IN (28, 29, 30)
            ORDER BY ou.id, oa.id;
        `;

        results.forEach(result => {
            console.log(`  - ${result.full_name} -> ${result.org_unit_name} (${result.position_title})`);
        });

        console.log('\nüéâ Ho√†n th√†nh! ƒê√£ insert assignments cho Tr∆∞·ªùng Y D∆∞·ª£c');

    } catch (error) {
        console.error('‚ùå L·ªói:', error.message);
        console.error('Chi ti·∫øt:', error);
        
        // Enable l·∫°i trigger n·∫øu c√≥ l·ªói
        try {
            await prisma.$executeRaw`
                ALTER TABLE hr.org_assignment ENABLE TRIGGER trg_hr_org_assignment_log;
            `;
            console.log('‚úÖ ƒê√£ enable l·∫°i trigger sau l·ªói');
        } catch (enableError) {
            console.log('‚ùå L·ªói enable trigger:', enableError.message);
        }
    } finally {
        await prisma.$disconnect();
    }
}

runInsertSQL();

