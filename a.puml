@startuml
!theme plain
title Logic Nghiệp vụ Module Tổ chức (Organization Module)

skinparam backgroundColor #FFFFFF
skinparam activity {
  BackgroundColor #E3F2FD
  BorderColor #1976D2
  FontColor #000000
}
skinparam activityDiamond {
  BackgroundColor #FFF3E0
  BorderColor #F57C00
  FontColor #000000
}
skinparam note {
  BackgroundColor #F3E5F5
  BorderColor #7B1FA2
  FontColor #000000
}

package "Quy trình Tạo Đơn vị Tổ chức" {
  start
  
  :Tạo yêu cầu thành lập đơn vị;
  note right: Nhập thông tin:\n- Tên đơn vị\n- Mã đơn vị\n- Loại đơn vị\n- Mô tả\n- Ngày dự kiến thành lập
  
  :Kiểm tra thông tin bắt buộc;
  note right: code, name, campus_id,\nowner_org_id, requester_id
  
  if (Thông tin hợp lệ?) then (Có)
    :Tạo OrgUnit với status 'draft';
    note right: Lưu vào database\nvới trạng thái ban đầu
    
    :Tạo OrgStructureRequest;
    note right: request_type: 'created'\nstatus: 'SUBMITTED'\nworkflow_step: 1
    
    :Tạo OrgUnitHistory;
    note right: Ghi lại lịch sử\ntạo đơn vị
    
    :Tạo OrgUnitRelation (nếu có parent);
    note right: Thiết lập quan hệ\ncha-con trong tổ chức
    
    :Chuyển sang bước Review;
    
  else (Không)
    :Trả về lỗi thiếu thông tin;
    :Yêu cầu bổ sung;
  endif
  
  stop
}

package "Quy trình Review/Thẩm định" {
  start
  
  :Nhận yêu cầu từ Draft;
  note right: workflow_step: 1\nstatus: 'SUBMITTED'
  
  :Kiểm tra tính hợp lệ;
  note right: - Tính hợp lệ của thông tin\n- Kiểm tra mã đơn vị trùng lặp\n- Kiểm tra cấu trúc tổ chức
  
  :Thẩm định nguồn lực;
  note right: - Ngân sách\n- Nhân sự\n- Cơ sở vật chất\n- Pháp lý
  
  if (Đủ điều kiện?) then (Có)
    :Tạo review record;
    note right: request_type: 'review'\nstatus: 'REVIEWED'\nworkflow_step: 2
    
    :Cập nhật OrgUnit status = 'review';
    
    :Chuyển sang bước Approve;
    
  else (Không)
    :Tạo review record từ chối;
    note right: review_result: 'rejected'
    
    :Cập nhật trạng thái từ chối;
    :Thông báo lý do từ chối;
  endif
  
  stop
}

package "Quy trình Approve/Phê duyệt" {
  start
  
  :Nhận yêu cầu từ Review;
  note right: workflow_step: 2\nstatus: 'REVIEWED'
  
  :Kiểm tra quyền phê duyệt;
  note right: Dựa trên vai trò:\n- RECTOR\n- DEAN\n- HEAD_DEPARTMENT
  
  if (Có quyền phê duyệt?) then (Có)
    :Đánh giá tính khả thi;
    note right: - Tác động đến tổ chức\n- Chiến lược phát triển\n- Nguồn lực dài hạn
    
    if (Quyết định?) then (Duyệt)
      :Tạo approval record;
      note right: request_type: 'approval'\nstatus: 'APPROVED'\nworkflow_step: 3
      
      :Cập nhật OrgUnit status = 'approved';
      
      :Chuyển sang bước Activate;
      
    else (Từ chối)
      :Tạo approval record từ chối;
      note right: approval_result: 'rejected'
      
      :Cập nhật trạng thái từ chối;
      :Thông báo lý do từ chối;
    endif
    
  else (Không)
    :Thông báo không có quyền;
    :Chuyển về người có quyền;
  endif
  
  stop
}

package "Quy trình Activate/Kích hoạt" {
  start
  
  :Nhận yêu cầu từ Approve;
  note right: workflow_step: 3\nstatus: 'APPROVED'
  
  :Thiết lập cấu trúc tổ chức;
  note right: - Cập nhật OrgUnitRelation\n- Thiết lập hierarchy\n- Cập nhật parent-child
  
  :Bổ nhiệm nhân sự;
  note right: - Tạo OrgAssignment\n- Phân công vai trò\n- Thiết lập quyền hạn
  
  :Cập nhật trạng thái cuối cùng;
  note right: OrgUnit status = 'active'\nworkflow_step: 4
  
  :Tạo audit log;
  note right: Ghi lại toàn bộ\nquá trình kích hoạt
  
  :Thông báo hoàn thành;
  note right: Gửi thông báo đến\ncác bên liên quan
  
  stop
}

package "Quản lý Trạng thái Đơn vị" {
  start
  
  :Theo dõi trạng thái đơn vị;
  note right: Các trạng thái:\n- draft: Nháp\n- review: Đang thẩm định\n- approved: Đã phê duyệt\n- active: Đang hoạt động\n- inactive: Tạm dừng\n- deleted: Đã xóa
  
  :Cập nhật trạng thái;
  note right: API: PUT /api/org/units/{id}/status
  
  :Ghi log thay đổi;
  note right: Lưu vào OrgUnitHistory\nvới change_type và details
  
  :Thông báo thay đổi;
  note right: Gửi thông báo đến\nngười liên quan
  
  stop
}

package "Quản lý Cấu trúc Tổ chức" {
  start
  
  :Xây dựng cây tổ chức;
  note right: Dựa trên parent_id\nvà OrgUnitRelation
  
  :Truy vấn đơn vị theo cấp;
  note right: - Tìm đơn vị cha\n- Tìm đơn vị con\n- Tính toán hierarchy level
  
  :Hiển thị sơ đồ tổ chức;
  note right: - Tree view\n- Diagram view\n- Org chart
  
  :Quản lý quan hệ đơn vị;
  note right: - Thêm/xóa quan hệ\n- Cập nhật hierarchy\n- Kiểm tra circular reference
  
  stop
}

package "Thống kê và Báo cáo" {
  start
  
  :Thu thập dữ liệu thống kê;
  note right: - Số lượng đơn vị theo trạng thái\n- Số lượng đơn vị theo loại\n- Phân bố theo campus\n- Tỷ lệ hoàn thành workflow
  
  :Tính toán KPI;
  note right: - Thời gian trung bình workflow\n- Tỷ lệ từ chối\n- Hiệu suất xử lý
  
  :Tạo báo cáo;
  note right: - Dashboard metrics\n- Detailed reports\n- Export data
  
  :Cập nhật real-time;
  note right: WebSocket hoặc\npolling để cập nhật
  
  stop
}

package "Audit và Lịch sử" {
  start
  
  :Ghi log mọi thay đổi;
  note right: OrgUnitHistory:\n- change_type\n- old_value/new_value\n- details\n- changed_at
  
  :Truy vấn lịch sử;
  note right: API: GET /api/org/units/audit\nvới filters và pagination
  
  :Theo dõi workflow history;
  note right: OrgStructureRequest:\n- workflow_step\n- status changes\n- actor information
  
  :Xuất audit report;
  note right: Compliance và\nregulatory reporting
  
  stop
}

@enduml